# 部署指南

本文档介绍如何使用新的配置化部署方式启动系统。

## 快速开始

### 1. 配置部署参数

编辑 `config.json` 文件，配置前后端的部署参数：

```json
{
  "backend": {
    "host": "0.0.0.0",
    "port": 8000,
    "public_url": "http://localhost:8000"
  },
  "frontend": {
    "host": "0.0.0.0",
    "port": 5173,
    "public_url": "http://localhost:5173",
    "api_url": "http://localhost:8000"
  }
}
```

**参数说明：**

- `host`: 服务监听地址
  - `0.0.0.0`: 监听所有网卡（可从外部访问）
  - `127.0.0.1`: 仅监听本地（只能本机访问）
  
- `port`: 服务端口号

- `public_url`: 对外访问地址
  - 本地部署: `http://localhost:端口`
  - 局域网部署: `http://192.168.x.x:端口`
  - 公网部署: `http://your-domain.com:端口`

- `api_url`: 前端访问后端的地址
  - 必须是前端浏览器能访问到的地址
  - 如果前后端在同一台机器，可以使用 `localhost`
  - 如果分开部署，需要使用后端的实际 IP 或域名

### 2. 启动服务

```bash
# 启动所有服务（后台运行）
python start.py
```

启动后会显示访问地址：

```
==================================================
服务已启动
==================================================
后端 API: http://localhost:8000
前端界面: http://localhost:5173

提示:
  - 进程已在后台运行
  - 使用 'python stop.py' 停止所有服务
  - 使用 'python status.py' 查看服务状态
==================================================
```

### 3. 查看服务状态

```bash
python status.py
```

### 4. 停止服务

```bash
python stop.py
```

## 部署场景示例

### 场景 1: 本地开发

```json
{
  "backend": {
    "host": "127.0.0.1",
    "port": 8000,
    "public_url": "http://localhost:8000"
  },
  "frontend": {
    "host": "127.0.0.1",
    "port": 5173,
    "public_url": "http://localhost:5173",
    "api_url": "http://localhost:8000"
  }
}
```

访问: http://localhost:5173

### 场景 2: 局域网部署

假设服务器 IP 为 `192.168.1.100`：

```json
{
  "backend": {
    "host": "0.0.0.0",
    "port": 8000,
    "public_url": "http://192.168.1.100:8000"
  },
  "frontend": {
    "host": "0.0.0.0",
    "port": 5173,
    "public_url": "http://192.168.1.100:5173",
    "api_url": "http://192.168.1.100:8000"
  }
}
```

局域网内其他设备访问: http://192.168.1.100:5173

### 场景 3: 公网部署（使用域名）

假设域名为 `example.com`：

```json
{
  "backend": {
    "host": "0.0.0.0",
    "port": 8000,
    "public_url": "https://api.example.com"
  },
  "frontend": {
    "host": "0.0.0.0",
    "port": 5173,
    "public_url": "https://example.com",
    "api_url": "https://api.example.com"
  }
}
```

**注意**: 公网部署需要配置反向代理（如 Nginx）和 SSL 证书。

### 场景 4: 前后端分离部署

后端服务器 `192.168.1.100`，前端服务器 `192.168.1.101`：

**后端配置** (192.168.1.100):
```json
{
  "backend": {
    "host": "0.0.0.0",
    "port": 8000,
    "public_url": "http://192.168.1.100:8000"
  }
}
```

**前端配置** (192.168.1.101):
```json
{
  "frontend": {
    "host": "0.0.0.0",
    "port": 5173,
    "public_url": "http://192.168.1.101:5173",
    "api_url": "http://192.168.1.100:8000"
  }
}
```

## 常见问题

### Q: 如何修改端口？

A: 编辑 `config.json`，修改对应的 `port` 字段，然后重启服务。

### Q: 局域网内其他设备无法访问？

A: 检查以下几点：
1. `host` 是否设置为 `0.0.0.0`
2. 防火墙是否开放了对应端口
3. `public_url` 和 `api_url` 是否使用了正确的 IP 地址

### Q: 前端无法连接后端？

A: 检查 `frontend.api_url` 是否正确：
- 必须是浏览器能访问到的地址
- 不能使用 `0.0.0.0`（应该使用实际 IP 或域名）
- 确保后端服务正在运行

### Q: 如何查看日志？

A: 日志文件位置：
- 后端日志: `backend/logs/`
- 前端日志: 在浏览器控制台查看

### Q: 服务异常退出怎么办？

A: 
1. 使用 `python status.py` 检查服务状态
2. 使用 `python stop.py` 清理残留进程
3. 检查日志文件排查问题
4. 重新启动: `python start.py`

## 与旧版启动脚本的区别

| 特性 | 旧版 (start_all.sh/bat) | 新版 (start.py) |
|------|------------------------|-----------------|
| 配置方式 | 硬编码在脚本中 | 统一配置文件 |
| 运行方式 | 前台运行，阻塞终端 | 后台运行 |
| 进程管理 | 手动管理 | 自动管理 PID |
| 跨平台 | 需要两个脚本 | 单一脚本 |
| 灵活性 | 低 | 高 |

旧版脚本仍然可用，但推荐使用新版配置化部署方式。

## 生产环境建议

1. **使用反向代理**: 使用 Nginx 或 Apache 作为反向代理
2. **配置 HTTPS**: 使用 Let's Encrypt 等免费证书
3. **进程守护**: 使用 systemd、supervisor 或 PM2 管理进程
4. **日志轮转**: 配置日志轮转避免日志文件过大
5. **监控告警**: 配置服务监控和告警机制

详细的生产环境部署请参考 `DEPLOYMENT.md`。
